<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="InfiniDepth Single Depth Demo">
    <meta name="author" content="Hao Yu">
    <title>InfiniDepth - Single Depth Demo</title>
    
    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- InfiniDepth Styles - ä½¿ç”¨åŸæœ‰çš„CSSæ–‡ä»¶ -->
    <link href="css/infinidepth/main.css" rel="stylesheet">
    <link href="css/infinidepth/title-animations.css" rel="stylesheet">
    <link href="css/infinidepth/magnifier.css" rel="stylesheet">
    
    <style>
        /* åªä¿®æ”¹depth-sideå¸ƒå±€,ä»2x2æ”¹ä¸ºå•å¼ å›¾ */
        .depth-side {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .depth-side .depth-item {
            width: 100%;
            max-width: 100%;
        }
        
        /* Canvasé€šè¿‡å†…éƒ¨åˆ†è¾¨ç‡ä¿æŒ16K,CSSæ§åˆ¶æ˜¾ç¤ºå°ºå¯¸ */
        .depth-side .depth-item canvas {
            /* æ˜¾ç¤ºå°ºå¯¸ç”±JSåŠ¨æ€è®¾ç½®ä¸ºä¸RGBå›¾ç›¸åŒ */
            display: block;
            /* ç¦ç”¨å›¾åƒå¹³æ»‘ä»¥ä¿æŒé”åˆ©çš„åƒç´  */
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            /* ç¡®ä¿canvasä¸è¢«é¢å¤–ç¼©æ”¾ */
            max-width: none !important;
            object-fit: contain;
        }
        
        /* éšè—å¤šä½™çš„canvas */
        #depthCanvas2,
        #depthCanvas3,
        #depthCanvas4 {
            display: none;
        }
        
        .depth-item:nth-child(2),
        .depth-item:nth-child(3),
        .depth-item:nth-child(4) {
            display: none;
        }
        
        /* éšè—æ‰€æœ‰æ–¹æ³•æ ‡æ³¨ */
        .depth-label {
            display: none !important;
        }
    </style>
</head>

<body>
    <!-- Cover Section -->
    <section>
        <div class="jumbotron text-center mt-0">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <h1>
                            <span class="title-main">InfiniDepth</span>: 
                            Single Depth Interactive Demo
                        </h1>
                        <h4>For Video Recording</h4>
                        <hr>
                        <p style="font-size: 1.1rem; color: #666;">
                            Interactive depth comparison with magnifier - optimized for screen recording
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section>
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="section-card">
                        <p><strong>Interactive Depth Comparison:</strong> Hover over the RGB image to explore depth details. The circular magnifier shows the original content at 1:1 scale.</p>
                        <p style="margin-top: 10px; padding: 10px; background: #f0f9ff; border-left: 4px solid #1772d0; border-radius: 4px;">
                            <strong>ğŸ® Controls:</strong><br>
                            <span style="margin-left: 20px;">â€¢ <kbd>[</kbd> or <kbd>-</kbd> : Zoom In (smaller patch, more detail)</span><br>
                            <span style="margin-left: 20px;">â€¢ <kbd>]</kbd> or <kbd>=</kbd> : Zoom Out (larger patch, more context)</span><br>
                            <span style="margin-left: 20px; color: #666; font-size: 0.9em;">Patch size range: 16Ã—16 to 512Ã—512 pixels</span>
                        </p>
                        
                        <!-- Case Navigation -->
                        <div style="display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 20px;">
                            <button id="prevCase" class="case-nav-btn" style="padding: 8px 16px; background-color: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s;">
                                â† Previous
                            </button>
                            <button id="nextCase" class="case-nav-btn" style="padding: 8px 16px; background-color: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s;">
                                Next â†’
                            </button>
                        </div>
                        
                        <!-- Interactive Comparison with Magnifier - å®Œå…¨ç›¸åŒçš„HTMLç»“æ„ -->
                        <div class="interactive-comparison">
                            <!-- Left: RGB Image -->
                            <div class="rgb-side" id="rgbSide">
                                <img src="images/pub/infinidepth/DSC_0250.png" class="rgb-image" id="rgbImage" alt="RGB Image">
                                <div class="magnifier-lens" id="magnifierLens"></div>
                                <div class="zoom-info" id="zoomInfo">Patch Size: 256Ã—256</div>
                            </div>
                            
                            <!-- Right: Depth Maps (ä¿æŒ4ä¸ªcanvasçš„HTMLç»“æ„,ä½†åªæ˜¾ç¤ºç¬¬ä¸€ä¸ª) -->
                            <div class="depth-side">
                                <div class="depth-item">
                                    <canvas id="depthCanvas1"></canvas>
                                    <div class="depth-label">InfiniDepth (Ours)</div>
                                </div>
                                <div class="depth-item">
                                    <canvas id="depthCanvas2"></canvas>
                                    <div class="depth-label">Method 2</div>
                                </div>
                                <div class="depth-item">
                                    <canvas id="depthCanvas3"></canvas>
                                    <div class="depth-label">Method 3</div>
                                </div>
                                <div class="depth-item">
                                    <canvas id="depthCanvas4"></canvas>
                                    <div class="depth-label">Method 4</div>
                                </div>
                            </div>
                        </div>
                    
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="text-center" style="margin-bottom: 10px; margin-top: 20px;">
        <p>
            Â© 2025 Hao Yu. All rights reserved.<br>
            <a href="infinidepth.html">â† Back to Full Demo</a> | 
            <a href="index.html">Back to Homepage</a>
        </p>
    </footer>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- å•ç‹¬çš„configæ–‡ä»¶ - åªä¿®æ”¹åœºæ™¯é…ç½®ä¸ºå•å¼ æ·±åº¦å›¾ -->
    <script>
        /**
         * Single Depth Configuration
         * åªä¿®æ”¹depthImagesæ•°ç»„,è®©å®ƒåªåŒ…å«ä¸€å¼ å›¾
         */
        const InfiniDepthConfig = {
            // Multiple scenes configuration
            scenes: [
                {
                    name: 'DSC_0250',
                    rgbImage: 'images/pub/infinidepth/DSC_6487.png',
                    depthImages: [
                        'images/pub/infinidepth/DSC_6487.png',
                        // ä¿æŒ4ä¸ªå…ƒç´ ,ä½†å3ä¸ªå¯ä»¥æ˜¯åŒä¸€å¼ å›¾æˆ–ç©º
                        'images/pub/infinidepth/Ours_DSC_6487_16k.png',
                        'images/pub/infinidepth/Ours_DSC_6487_16k.png',
                        'images/pub/infinidepth/Ours_DSC_6487_16k.png'
                    ],
                    methodLabels: [
                        'InfiniDepth (Ours)',
                        'Method 2',
                        'Method 3',
                        'Method 4'
                    ]
                },
                {
                    name: 'Demo Scene 2',
                    rgbImage: 'images/pub/infinidepth/DSC_0250.png',
                    depthImages: [
                        'images/pub/infinidepth/MoGe-2_0250.png',
                        'images/pub/infinidepth/MoGe-2_0250.png',
                        'images/pub/infinidepth/MoGe-2_0250.png',
                        'images/pub/infinidepth/MoGe-2_0250.png'
                    ],
                    methodLabels: [
                        'Baseline Method',
                        'Method 2',
                        'Method 3',
                        'Method 4'
                    ]
                }
                // æ·»åŠ æ›´å¤šåœºæ™¯,åªéœ€ä¿®æ”¹ç¬¬ä¸€ä¸ªdepthImageså…ƒç´ 
            ],
            
            // ä»¥ä¸‹é…ç½®ä¿æŒä¸åŸå§‹ä¸€è‡´
            initialPatchSize: 256,
            minPatchSize: 32,       // æœ€å¤§16å€æ”¾å¤§ (512/32=16)
            maxPatchSize: 512,
            zoomStep: 0.1,
            lensColor: '#6b9ac4',
            lensOpacity: 0.15,
            canvasWidth: 512,
            canvasHeight: 512,
            transitionDuration: 500
        };
    </script>
    
    <!-- ç›´æ¥ä½¿ç”¨åŸæœ‰çš„magnifier.js - å®Œå…¨ä¸ä¿®æ”¹ -->
    <script src="js/infinidepth/magnifier.js"></script>
    
    <!-- åˆå§‹åŒ– -->
    <script>
        // ä½¿ç”¨åŸæœ‰çš„DepthMagnifierç±»,åªè¦†ç›–canvaså°ºå¯¸è®¾ç½®ä»¥ä¿æŒ16Kåˆ†è¾¨ç‡
        document.addEventListener('DOMContentLoaded', () => {
            const magnifier = new DepthMagnifier(InfiniDepthConfig);
            
            // å­˜å‚¨canvasæ˜¯å¦å·²åˆå§‹åŒ–çš„æ ‡è®°
            const canvasInitialized = [false, false, false, false];
            
            // ğŸ¯ ä¼˜åŒ–æ ‡å¿—: é˜²æ­¢é‡å¤æ¸²æŸ“å¯¼è‡´çš„é—ªçƒ
            let isDrawing = false;
            let pendingDrawRequest = null;
            
            // è¦†ç›–initializeCanvasSizesæ–¹æ³•,è®©canvasä¿æŒ16å€åˆ†è¾¨ç‡
            magnifier.initializeCanvasSizes = function() {
                if (!this.rgbImage) return;
                
                const rgbDisplayHeight = this.rgbImage.offsetHeight;
                const rgbDisplayWidth = this.rgbImage.offsetWidth;
                const rgbNaturalWidth = this.rgbImage.naturalWidth;
                const rgbNaturalHeight = this.rgbImage.naturalHeight;
                
                console.log(`RGB - Display: ${rgbDisplayWidth}x${rgbDisplayHeight}, Natural: ${rgbNaturalWidth}x${rgbNaturalHeight}`);
                
                // åªå¤„ç†ç¬¬ä¸€ä¸ªcanvas(å•å¼ æ·±åº¦å›¾)
                const canvas = this.canvases[0];
                const depthImg = this.depthImagesLoaded[0];
                
                if (canvas) {
                    if (depthImg && !canvasInitialized[0]) {
                        // Canvaså†…éƒ¨åˆ†è¾¨ç‡ = æ·±åº¦å›¾åŸå§‹åˆ†è¾¨ç‡(16K)
                        canvas.width = depthImg.naturalWidth || depthImg.width;
                        canvas.height = depthImg.naturalHeight || depthImg.height;
                        
                        // CSSæ˜¾ç¤ºå°ºå¯¸ = RGBå›¾æ˜¾ç¤ºå°ºå¯¸(é€šè¿‡styleè®¾ç½®)
                        canvas.style.width = rgbDisplayWidth + 'px';
                        canvas.style.height = rgbDisplayHeight + 'px';
                        
                        // æ ‡è®°ä¸ºå·²åˆå§‹åŒ–
                        canvasInitialized[0] = true;
                        
                        console.log(`Depth Canvas 0: Internal ${canvas.width}x${canvas.height}, Display ${rgbDisplayWidth}x${rgbDisplayHeight}`);
                        console.log(`Resolution ratio: ${(canvas.width / rgbNaturalWidth).toFixed(1)}x`);
                    } else if (!depthImg) {
                        // æ·±åº¦å›¾è¿˜æ²¡åŠ è½½æ—¶,å…ˆè®¾ç½®ä¸ºRGBçš„16å€
                        canvas.width = rgbNaturalWidth * 16;
                        canvas.height = rgbNaturalHeight * 16;
                        canvas.style.width = rgbDisplayWidth + 'px';
                        canvas.style.height = rgbDisplayHeight + 'px';
                    } else if (canvasInitialized[0]) {
                        // å·²åˆå§‹åŒ–,åªæ›´æ–°CSSæ˜¾ç¤ºå°ºå¯¸(çª—å£resizeæ—¶)
                        canvas.style.width = rgbDisplayWidth + 'px';
                        canvas.style.height = rgbDisplayHeight + 'px';
                    }
                    
                    // é‡æ–°ç»˜åˆ¶
                    if (this.depthImagesLoaded[0]) {
                        this.drawFullDepth(0);
                    }
                }
            };
            
            // è¦†ç›–drawFullDepthæ–¹æ³•,1:1ç»˜åˆ¶ä¿æŒåŸå§‹åˆ†è¾¨ç‡
            magnifier.drawFullDepth = function(index) {
                // åªå¤„ç†ç¬¬ä¸€ä¸ªcanvas,å¿½ç•¥å…¶ä»–çš„
                if (index !== 0) return;
                
                if (!this.depthImagesLoaded[0] || !this.contexts[0]) return;
                
                const canvas = this.canvases[0];
                const ctx = this.contexts[0];
                const img = this.depthImagesLoaded[0];
                
                // ç¬¬ä¸€æ¬¡ç»˜åˆ¶æ—¶è®¾ç½®canvaså°ºå¯¸
                if (!canvasInitialized[0]) {
                    canvas.width = img.naturalWidth || img.width;
                    canvas.height = img.naturalHeight || img.height;
                    
                    const rgbDisplayWidth = this.rgbImage.offsetWidth;
                    const rgbDisplayHeight = this.rgbImage.offsetHeight;
                    canvas.style.width = rgbDisplayWidth + 'px';
                    canvas.style.height = rgbDisplayHeight + 'px';
                    
                    canvasInitialized[0] = true;
                    console.log(`âœ“ Canvas 0 initialized: ${canvas.width}x${canvas.height} internal, ${rgbDisplayWidth}x${rgbDisplayHeight} display`);
                }
                
                // ç¦ç”¨å›¾åƒå¹³æ»‘ä»¥ä¿æŒé”åˆ©
                ctx.imageSmoothingEnabled = false;
                
                // æ¸…ç©ºå¹¶é‡æ–°ç»˜åˆ¶å®Œæ•´å›¾åƒ
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
            };
            
            // è¦†ç›–drawPatchDepthæ–¹æ³•,åªå¤„ç†ç¬¬ä¸€ä¸ªcanvaså¹¶ä¿æŒ16Kåˆ†è¾¨ç‡é‡‡æ ·
            magnifier.drawPatchDepth = function(index, centerX, centerY) {
                // åªå¤„ç†ç¬¬ä¸€ä¸ªcanvas,å¿½ç•¥å…¶ä»–çš„
                if (index !== 0) return;
                
                if (!this.depthImagesLoaded[0] || !this.contexts[0]) return;
                
                // ç¡®ä¿canvaså·²åˆå§‹åŒ–ä¸ºé«˜åˆ†è¾¨ç‡
                if (!canvasInitialized[0]) {
                    this.drawFullDepth(0);
                    return;
                }
                
                // ğŸ¯ ä½¿ç”¨requestAnimationFrameé˜²æ­¢é‡å¤æ¸²æŸ“
                if (isDrawing) {
                    // å¦‚æœæ­£åœ¨ç»˜åˆ¶,ä¿å­˜è¯·æ±‚ä»¥ä¾¿ä¸‹æ¬¡æ‰§è¡Œ
                    pendingDrawRequest = { index, centerX, centerY };
                    return;
                }
                
                isDrawing = true;
                
                requestAnimationFrame(() => {
                    try {
                        const canvas = this.canvases[0];
                        const ctx = this.contexts[0];
                        const img = this.depthImagesLoaded[0];
                        
                        if (!canvas || !ctx || !img) {
                            isDrawing = false;
                            return;
                        }
                        
                        // ç¦ç”¨å›¾åƒå¹³æ»‘ä»¥ä¿æŒé”åˆ©
                        ctx.imageSmoothingEnabled = false;
                        
                        // è·å–RGBå›¾åƒå°ºå¯¸
                        const rgbDisplayWidth = this.rgbImage.offsetWidth;
                        const rgbDisplayHeight = this.rgbImage.offsetHeight;
                        const rgbNaturalWidth = this.rgbImage.naturalWidth;
                        const rgbNaturalHeight = this.rgbImage.naturalHeight;
                        
                        // è®¡ç®—é¼ æ ‡åœ¨RGBè‡ªç„¶åæ ‡ä¸­çš„ä½ç½®
                        const rgbNaturalX = (centerX / rgbDisplayWidth) * rgbNaturalWidth;
                        const rgbNaturalY = (centerY / rgbDisplayHeight) * rgbNaturalHeight;
                        
                        // è®¡ç®—patchåœ¨RGBè‡ªç„¶å°ºå¯¸ä¸­çš„æ¯”ä¾‹
                        const patchRatioX = this.patchSize / rgbNaturalWidth;
                        const patchRatioY = this.patchSize / rgbNaturalHeight;
                        
                        // åº”ç”¨ç›¸åŒæ¯”ä¾‹åˆ°16Kæ·±åº¦å›¾
                        const depthWidth = img.naturalWidth || img.width;
                        const depthHeight = img.naturalHeight || img.height;
                        const depthPatchWidth = patchRatioX * depthWidth;
                        const depthPatchHeight = patchRatioY * depthHeight;
                        
                        // å°†ä¸­å¿ƒä½ç½®ä»RGBæ˜ å°„åˆ°æ·±åº¦å›¾åæ ‡
                        const depthCenterX = (rgbNaturalX / rgbNaturalWidth) * depthWidth;
                        const depthCenterY = (rgbNaturalY / rgbNaturalHeight) * depthHeight;
                        
                        // è®¡ç®—æ·±åº¦å›¾ä¸­çš„æºçŸ©å½¢ (ä»16Kå›¾åƒé‡‡æ ·)
                        let sx = depthCenterX - depthPatchWidth / 2;
                        let sy = depthCenterY - depthPatchHeight / 2;
                        let sw = depthPatchWidth;
                        let sh = depthPatchHeight;
                        
                        // è¾¹ç•Œæ£€æŸ¥
                        if (sx < 0) { sw += sx; sx = 0; }
                        if (sy < 0) { sh += sy; sy = 0; }
                        if (sx + sw > depthWidth) sw = depthWidth - sx;
                        if (sy + sh > depthHeight) sh = depthHeight - sy;
                        
                        // æ¸…ç©ºcanvas
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        
                        // ğŸ¯ å…³é”®: å°†16Kæ·±åº¦å›¾çš„patchåŒºåŸŸç¼©æ”¾å¡«å……åˆ°æ•´ä¸ªcanvas
                        // è¿™æ ·å°±å®ç°äº†"æ”¾å¤§é•œ"æ•ˆæœ - ä»16Ké‡‡æ ·ï¼Œæ˜¾ç¤ºåœ¨canvaså°ºå¯¸
                        ctx.drawImage(
                            img,
                            sx, sy, sw, sh,              // æº: 16Kæ·±åº¦å›¾ä¸­çš„patchåŒºåŸŸ
                            0, 0, canvas.width, canvas.height  // ç›®æ ‡: å¡«å……æ•´ä¸ªcanvas
                        );
                        
                    } catch (err) {
                        console.error('Error drawing patch:', err);
                    } finally {
                        isDrawing = false;
                        
                        // å¦‚æœæœ‰å¾…å¤„ç†çš„è¯·æ±‚,æ‰§è¡Œå®ƒ
                        if (pendingDrawRequest) {
                            const req = pendingDrawRequest;
                            pendingDrawRequest = null;
                            this.drawPatchDepth(req.index, req.centerX, req.centerY);
                        }
                    }
                });
            };
            
            // âŒ ä¸è¦è¦†ç›– updateLensPosition - ä¿æŒåŸæœ‰é€»è¾‘
            // åŸæœ‰çš„ updateLensPosition ä¼šè‡ªåŠ¨è°ƒç”¨ drawMagnifiedContent å’Œ drawPatchDepth
            
            // ğŸš« å®Œå…¨ç¦ç”¨é¼ æ ‡æ»šè½®ç¼©æ”¾
            magnifier.handleWheel = function(e) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            };
            
            // æ·»åŠ é«˜ä¼˜å…ˆçº§çš„wheeläº‹ä»¶ç›‘å¬å™¨æ¥é˜»æ­¢é»˜è®¤è¡Œä¸º
            const rgbSide = document.getElementById('rgbSide');
            if (rgbSide) {
                rgbSide.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }, { passive: false, capture: true });
                
                console.log('âœ“ é¼ æ ‡æ»šè½®ç¼©æ”¾å·²å®Œå…¨ç¦ç”¨');
            }
            
            // ğŸ® æ·»åŠ é”®ç›˜æ§åˆ¶ç¼©æ”¾åŠŸèƒ½
            document.addEventListener('keydown', (e) => {
                // åªåœ¨é¼ æ ‡æ‚¬åœåœ¨å›¾åƒä¸Šæ—¶å“åº”é”®ç›˜
                if (!magnifier.isHovering) return;
                
                const oldPatchSize = magnifier.patchSize;
                let newPatchSize = oldPatchSize;
                
                // ä½¿ç”¨ '[' å’Œ ']' é”®æ§åˆ¶ç¼©æ”¾ (æˆ–è€… '-' å’Œ '=' é”®)
                if (e.key === '[' || e.key === '-') {
                    // Zoom In (å‡å°patch size)
                    newPatchSize = Math.max(
                        InfiniDepthConfig.minPatchSize,
                        oldPatchSize - 32  // æ¯æ¬¡å‡å°32åƒç´ 
                    );
                    e.preventDefault();
                } else if (e.key === ']' || e.key === '=') {
                    // Zoom Out (å¢å¤§patch size)
                    newPatchSize = Math.min(
                        InfiniDepthConfig.maxPatchSize,
                        oldPatchSize + 32  // æ¯æ¬¡å¢å¤§32åƒç´ 
                    );
                    e.preventDefault();
                } else {
                    return; // ä¸æ˜¯ç¼©æ”¾é”®,ç›´æ¥è¿”å›
                }
                
                // å¦‚æœpatch sizeæ”¹å˜äº†,æ›´æ–°å¹¶é‡æ–°ç»˜åˆ¶
                if (newPatchSize !== oldPatchSize) {
                    const oldSize = magnifier.patchSize;
                    magnifier.patchSize = newPatchSize;
                    
                    // ğŸ¯ å…³é”®ä¿®å¤: æ¨¡æ‹Ÿæ»šè½®è¡Œä¸º,è§¦å‘åŸæœ‰çš„ updateLensPosition
                    // ä½¿ç”¨åŸæœ‰çš„ lastMouseEvent æˆ– mousePos
                    if (magnifier.lastMouseEvent) {
                        // ç›´æ¥ä¼ é€’åŸæœ‰çš„äº‹ä»¶å¯¹è±¡
                        magnifier.updateLensPosition(magnifier.lastMouseEvent);
                        console.log(`ğŸ” Keyboard Zoom ${newPatchSize < oldSize ? 'In' : 'Out'}: ${oldSize} â†’ ${newPatchSize}`);
                    } else {
                        console.warn('âš ï¸ No mouse position. Move mouse over image first.');
                    }
                }
            });
        });
    </script>
            
            // è¦†ç›–initializeCanvasSizesæ–¹æ³•,è®©canvasä¿æŒ16å€åˆ†è¾¨ç‡
            magnifier.initializeCanvasSizes = function() {
                if (!this.rgbImage) return;
                
                const rgbDisplayHeight = this.rgbImage.offsetHeight;
                const rgbDisplayWidth = this.rgbImage.offsetWidth;
                const rgbNaturalWidth = this.rgbImage.naturalWidth;
                const rgbNaturalHeight = this.rgbImage.naturalHeight;
                
                console.log(`RGB - Display: ${rgbDisplayWidth}x${rgbDisplayHeight}, Natural: ${rgbNaturalWidth}x${rgbNaturalHeight}`);
                
                // åªå¤„ç†ç¬¬ä¸€ä¸ªcanvas(å•å¼ æ·±åº¦å›¾)
                const canvas = this.canvases[0];
                const depthImg = this.depthImagesLoaded[0];
                
                if (canvas) {
                    if (depthImg && !canvasInitialized[0]) {
                        // Canvaså†…éƒ¨åˆ†è¾¨ç‡ = æ·±åº¦å›¾åŸå§‹åˆ†è¾¨ç‡(16K)
                        canvas.width = depthImg.naturalWidth || depthImg.width;
                        canvas.height = depthImg.naturalHeight || depthImg.height;
                        
                        // CSSæ˜¾ç¤ºå°ºå¯¸ = RGBå›¾æ˜¾ç¤ºå°ºå¯¸(é€šè¿‡styleè®¾ç½®)
                        canvas.style.width = rgbDisplayWidth + 'px';
                        canvas.style.height = rgbDisplayHeight + 'px';
                        
                        // æ ‡è®°ä¸ºå·²åˆå§‹åŒ–
                        canvasInitialized[0] = true;
                        
                        console.log(`Depth Canvas 0: Internal ${canvas.width}x${canvas.height}, Display ${rgbDisplayWidth}x${rgbDisplayHeight}`);
                        console.log(`Resolution ratio: ${(canvas.width / rgbNaturalWidth).toFixed(1)}x`);
                    } else if (!depthImg) {
                        // æ·±åº¦å›¾è¿˜æ²¡åŠ è½½æ—¶,å…ˆè®¾ç½®ä¸ºRGBçš„16å€
                        canvas.width = rgbNaturalWidth * 16;
                        canvas.height = rgbNaturalHeight * 16;
                        canvas.style.width = rgbDisplayWidth + 'px';
                        canvas.style.height = rgbDisplayHeight + 'px';
                    } else if (canvasInitialized[0]) {
                        // å·²åˆå§‹åŒ–,åªæ›´æ–°CSSæ˜¾ç¤ºå°ºå¯¸(çª—å£resizeæ—¶)
                        canvas.style.width = rgbDisplayWidth + 'px';
                        canvas.style.height = rgbDisplayHeight + 'px';
                    }
                    
                    // é‡æ–°ç»˜åˆ¶
                    if (this.depthImagesLoaded[0]) {
                        this.drawFullDepth(0);
                    }
                }
            };
            
            // è¦†ç›–drawFullDepthæ–¹æ³•,1:1ç»˜åˆ¶ä¿æŒåŸå§‹åˆ†è¾¨ç‡
            const originalDrawFullDepth = magnifier.drawFullDepth.bind(magnifier);
            magnifier.drawFullDepth = function(index) {
                // åªå¤„ç†ç¬¬ä¸€ä¸ªcanvas,å¿½ç•¥å…¶ä»–çš„
                if (index !== 0) return;
                
                if (!this.depthImagesLoaded[0] || !this.contexts[0]) return;
                
                const canvas = this.canvases[0];
                const ctx = this.contexts[0];
                const img = this.depthImagesLoaded[0];
                
                // ç¬¬ä¸€æ¬¡ç»˜åˆ¶æ—¶è®¾ç½®canvaså°ºå¯¸
                if (!canvasInitialized[0]) {
                    canvas.width = img.naturalWidth || img.width;
                    canvas.height = img.naturalHeight || img.height;
                    
                    const rgbDisplayWidth = this.rgbImage.offsetWidth;
                    const rgbDisplayHeight = this.rgbImage.offsetHeight;
                    canvas.style.width = rgbDisplayWidth + 'px';
                    canvas.style.height = rgbDisplayHeight + 'px';
                    
                    canvasInitialized[0] = true;
                    console.log(`âœ“ Canvas 0 initialized: ${canvas.width}x${canvas.height} internal, ${rgbDisplayWidth}x${rgbDisplayHeight} display`);
                }
                
                // ç¦ç”¨å›¾åƒå¹³æ»‘ä»¥ä¿æŒé”åˆ©
                ctx.imageSmoothingEnabled = false;
                
                // æ¸…ç©ºå¹¶é‡æ–°ç»˜åˆ¶å®Œæ•´å›¾åƒ
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
            };
            
            // è¦†ç›–drawPatchDepthæ–¹æ³•,åªå¤„ç†ç¬¬ä¸€ä¸ªcanvaså¹¶ä¿æŒ16Kåˆ†è¾¨ç‡é‡‡æ ·
            magnifier.drawPatchDepth = function(index, centerX, centerY) {
                // åªå¤„ç†ç¬¬ä¸€ä¸ªcanvas,å¿½ç•¥å…¶ä»–çš„
                if (index !== 0) return;
                
                if (!this.depthImagesLoaded[0] || !this.contexts[0]) return;
                
                // ç¡®ä¿canvaså·²åˆå§‹åŒ–ä¸ºé«˜åˆ†è¾¨ç‡
                if (!canvasInitialized[0]) {
                    this.drawFullDepth(0);
                    return;
                }
                
                // ğŸ¯ ä½¿ç”¨requestAnimationFrameé˜²æ­¢é‡å¤æ¸²æŸ“
                if (isDrawing) {
                    // å¦‚æœæ­£åœ¨ç»˜åˆ¶,ä¿å­˜è¯·æ±‚ä»¥ä¾¿ä¸‹æ¬¡æ‰§è¡Œ
                    pendingDrawRequest = { index, centerX, centerY };
                    return;
                }
                
                isDrawing = true;
                
                requestAnimationFrame(() => {
                    try {
                        const canvas = this.canvases[0];
                        const ctx = this.contexts[0];
                        const img = this.depthImagesLoaded[0];
                        
                        if (!canvas || !ctx || !img) {
                            isDrawing = false;
                            return;
                        }
                        
                        // ç¦ç”¨å›¾åƒå¹³æ»‘ä»¥ä¿æŒé”åˆ©
                        ctx.imageSmoothingEnabled = false;
                        
                        // è·å–RGBå›¾åƒå°ºå¯¸
                        const rgbDisplayWidth = this.rgbImage.offsetWidth;
                        const rgbDisplayHeight = this.rgbImage.offsetHeight;
                        const rgbNaturalWidth = this.rgbImage.naturalWidth;
                        const rgbNaturalHeight = this.rgbImage.naturalHeight;
                        
                        // è®¡ç®—é¼ æ ‡åœ¨RGBè‡ªç„¶åæ ‡ä¸­çš„ä½ç½®
                        const rgbNaturalX = (centerX / rgbDisplayWidth) * rgbNaturalWidth;
                        const rgbNaturalY = (centerY / rgbDisplayHeight) * rgbNaturalHeight;
                        
                        // è®¡ç®—patchåœ¨RGBè‡ªç„¶å°ºå¯¸ä¸­çš„æ¯”ä¾‹
                        const patchRatioX = this.patchSize / rgbNaturalWidth;
                        const patchRatioY = this.patchSize / rgbNaturalHeight;
                        
                        // åº”ç”¨ç›¸åŒæ¯”ä¾‹åˆ°16Kæ·±åº¦å›¾
                        const depthWidth = img.naturalWidth || img.width;
                        const depthHeight = img.naturalHeight || img.height;
                        const depthPatchWidth = patchRatioX * depthWidth;
                        const depthPatchHeight = patchRatioY * depthHeight;
                        
                        // å°†ä¸­å¿ƒä½ç½®ä»RGBæ˜ å°„åˆ°æ·±åº¦å›¾åæ ‡
                        const depthCenterX = (rgbNaturalX / rgbNaturalWidth) * depthWidth;
                        const depthCenterY = (rgbNaturalY / rgbNaturalHeight) * depthHeight;
                        
                        // è®¡ç®—æ·±åº¦å›¾ä¸­çš„æºçŸ©å½¢ (ä»16Kå›¾åƒé‡‡æ ·)
                        let sx = depthCenterX - depthPatchWidth / 2;
                        let sy = depthCenterY - depthPatchHeight / 2;
                        let sw = depthPatchWidth;
                        let sh = depthPatchHeight;
                        
                        // è¾¹ç•Œæ£€æŸ¥
                        if (sx < 0) { sw += sx; sx = 0; }
                        if (sy < 0) { sh += sy; sy = 0; }
                        if (sx + sw > depthWidth) sw = depthWidth - sx;
                        if (sy + sh > depthHeight) sh = depthHeight - sy;
                        
                        // æ¸…ç©ºcanvas
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        
                        // ğŸ¯ å…³é”®: å°†16Kæ·±åº¦å›¾çš„patchåŒºåŸŸç¼©æ”¾å¡«å……åˆ°æ•´ä¸ªcanvas
                        // è¿™æ ·å°±å®ç°äº†"æ”¾å¤§é•œ"æ•ˆæœ - ä»16Ké‡‡æ ·ï¼Œæ˜¾ç¤ºåœ¨canvaså°ºå¯¸
                        ctx.drawImage(
                            img,
                            sx, sy, sw, sh,              // æº: 16Kæ·±åº¦å›¾ä¸­çš„patchåŒºåŸŸ
                            0, 0, canvas.width, canvas.height  // ç›®æ ‡: å¡«å……æ•´ä¸ªcanvas
                        );
                        
                    } catch (err) {
                        console.error('Error drawing patch:', err);
                    } finally {
                        isDrawing = false;
                        
                        // å¦‚æœæœ‰å¾…å¤„ç†çš„è¯·æ±‚,æ‰§è¡Œå®ƒ
                        if (pendingDrawRequest) {
                            const req = pendingDrawRequest;
                            pendingDrawRequest = null;
                            this.drawPatchDepth(req.index, req.centerX, req.centerY);
                        }
                    }
                });
            };
            
        });
    </script>
</body>
</html>
